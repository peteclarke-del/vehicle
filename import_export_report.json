{
  "metadata": {
    "generatedAt": "2026-01-22T00:00:00Z",
    "generator": "assistant",
    "rootController": "backend/src/Controller/VehicleImportExportController.php"
  },
  "controller_locations": {
    "export": "backend/src/Controller/VehicleImportExportController.php#L22-L170",
    "import": "backend/src/Controller/VehicleImportExportController.php#L170-L1159"
  },
  "entities": [
    {
      "name": "Vehicle",
      "classFile": "backend/src/Entity/Vehicle.php",
      "entityFields": ["id","owner","vehicleType","name","make","model","year","vin","vinDecodedData","vinDecodedAt","registrationNumber","engineNumber","v5DocumentNumber","purchaseCost","purchaseDate","purchaseMileage","securityFeatures","vehicleColor","serviceIntervalMonths","serviceIntervalMiles","depreciationMethod","depreciationYears","depreciationRate","createdAt","updatedAt","roadTaxExempt","motExempt","images"],
      "exportedFields": ["name","vehicleType","make","model","year","vin","registrationNumber","engineNumber","v5DocumentNumber","purchaseCost","purchaseDate","purchaseMileage","roadTaxExempt","motExempt","securityFeatures","vehicleColor","serviceIntervalMonths","serviceIntervalMiles","depreciationMethod","depreciationYears","depreciationRate","fuelRecords","parts","consumables","serviceRecords","motRecords","insuranceRecords","roadTaxRecords"],
      "missingOnExport": ["id","owner","vinDecodedData","vinDecodedAt","updatedAt","images"],
      "importHandling": "Vehicles are created in first pass by registrationNumber; owner set to authenticated user.",
      "issues": [
        "Images (VehicleImage) are not exported nor imported despite `images` relation on `Vehicle`.",
        "VIN decoded data/state (`vinDecodedData`, `vinDecodedAt`) is not exported; importing VIN alone will not restore decoded metadata.",
        "updatedAt is not preserved on export/import.",
        "Owner is implicitly set at import; exported payload lacks owner id (by design) but tests expect idempotent round-trip per user."
      ],
      "recommendedFixes": [
        {"desc":"Include `images` export (path, caption, isPrimary, displayOrder, sourceUrl, uploadedAt) and import mapping; persist VehicleImage entities and set relationships.","file":"backend/src/Controller/VehicleImportExportController.php","where":"export:within vehicle loop / import: within second pass after vehicle creation, when processing vehicleData.images"},
        {"desc":"Export `vinDecodedData` and `vinDecodedAt` so import can restore vehicle decoding state or re-run decode only when missing.","file":"backend/src/Controller/VehicleImportExportController.php","where":"export vehicleData"},
        {"desc":"Export and import `updatedAt` to preserve record timestamps where provided.","file":"backend/src/Controller/VehicleImportExportController.php","where":"export and import vehicle fields"}
      ]
    },
    {
      "name": "Part",
      "classFile": "backend/src/Entity/Part.php",
      "entityFields": ["id","vehicle","purchaseDate","description","name","price","partNumber","sku","manufacturer","supplier","quantity","warrantyMonths","imageUrl","cost","category","installationDate","mileageAtInstallation","notes","serviceRecord","motRecord","createdAt","receiptAttachmentId","productUrl"],
      "exportedFields": ["purchaseDate","description","partNumber","manufacturer","supplier","cost","category","installationDate","mileageAtInstallation","notes","receiptAttachmentId","productUrl","createdAt"],
      "missingOnExport": ["id","name","price","sku","quantity","warrantyMonths","imageUrl","serviceRecord","motRecord_id_explicit","createdAt vs timezone"],
      "importHandling": "Import creates parts in vehicle-level 'parts' array and associates parts nested under MOT to the created MotRecord; import tries to match existing part by partNumber+installationDate or description+installationDate before creating new.",
      "issues": [
        "Export omits `quantity`, `sku`, `price` fields which exist on the entity and may be meaningful for consumers.",
        "Import does not accept external `id` (no explicit id mapping) — round-trip will produce new IDs and duplicate detection only uses heuristics; may duplicate items if heuristics fail.",
        "Parts linked to ServiceRecords are not exported with `serviceRecord` reference (serviceRecords export uses its own items but cross-link to original part id is lost)."
      ],
      "recommendedFixes": [
        {"desc":"Export `id` optionally and `sku`,`quantity`,`price`,`imageUrl`,`warrantyMonths` so imports can match or preserve these fields.","file":"backend/src/Controller/VehicleImportExportController.php","where":"export parts block"},
        {"desc":"On import, if `id` exists and matches an existing Part for the same vehicle, update instead of always creating; otherwise use the existing heuristics.","file":"backend/src/Controller/VehicleImportExportController.php","where":"import parts loop"},
        {"desc":"When importing parts nested under MOT, ensure that `motRecord` is set and call server-side repair cost recalculation (use existing `RepairCostCalculator`).","file":"backend/src/Controller/VehicleImportExportController.php","where":"after persisting motRecord and related parts"}
      ]
    },
    {
      "name": "Consumable",
      "classFile": "backend/src/Entity/Consumable.php",
      "entityFields": ["id","vehicle","consumableType","specification","name","brand","partNumber","replacementIntervalMiles","nextReplacementMileage","quantity","lastChanged","mileageAtChange","cost","notes","serviceRecord","motRecord","createdAt","updatedAt","receiptAttachmentId","productUrl","supplier"],
      "exportedFields": ["consumableType","specification","quantity","lastChanged","mileageAtChange","cost","notes","receiptAttachmentId","productUrl","createdAt"],
      "missingOnExport": ["id","name","brand","partNumber","replacementIntervalMiles","nextReplacementMileage","updatedAt","supplier","serviceRecord","motRecord_id_explicit"],
      "importHandling": "Import will create consumable types if missing and persist consumables; when nested under MOT, it will attempt to match by vehicle+type+lastChanged before creating.",
      "issues": [
        "UpdatedAt not preserved on export/import.",
        "Supplier, brand and other metadata are not exported which may be desired.",
        "Quantity uses decimal in entity but export/import treat it as numeric; ensure consistent casting.",
        "Import associates existing consumables by lastChanged which may be brittle (timezone/format differences)."
      ],
      "recommendedFixes": [
        {"desc":"Include `id`, `name`, `brand`, `partNumber`, `supplier`, `updatedAt` in export and import mapping.","file":"backend/src/Controller/VehicleImportExportController.php","where":"export/import consumables blocks"},
        {"desc":"When matching existing consumables, consider also matching `receiptAttachmentId` or `cost` to reduce false negatives.","file":"backend/src/Controller/VehicleImportExportController.php","where":"mot nested consumables import"}
      ]
    },
    {
      "name": "ServiceRecord",
      "classFile": "backend/src/Entity/ServiceRecord.php",
      "entityFields": ["id","vehicle","serviceDate","serviceType","laborCost","partsCost","mileage","serviceProvider","workshop","workPerformed","description","additionalCosts","nextServiceDate","nextServiceMileage","notes","createdAt","receiptAttachmentId","motRecord","items"],
      "exportedFields": ["serviceDate","serviceType","laborCost","partsCost","mileage","serviceProvider","workPerformed","notes","items","receiptAttachmentId","createdAt"],
      "missingOnExport": ["id","workshop","description","additionalCosts","nextServiceDate","nextServiceMileage","motRecord_id_explicit"],
      "importHandling": "Import creates service records then attempts to match nested serviceRecords under MOT, using (serviceDate,mileage,serviceProvider) heuristics; items are persisted as ServiceItem entities.",
      "issues": [
        "ServiceRecord `description` (alias for workPerformed) and `workshop` fields are not exported explicitly.",
        "Import does not set `nextServiceDate`/`nextServiceMileage` when exported, so recurrence scheduling data is lost.",
        "ServiceRecord <-> Part linkage is not preserved; parts used in a service are not cross-linked by id in export." 
      ],
      "recommendedFixes": [
        {"desc":"Export `id`, `workshop`, `description`, `additionalCosts`, `nextServiceDate`, `nextServiceMileage`.","file":"backend/src/Controller/VehicleImportExportController.php","where":"export serviceRecords block"},
        {"desc":"On import, if `id` present and exists for vehicle, update instead of creating; also associate/restore `motRecord` references and call `RepairCostCalculator` after attaching service records to MOTs.","file":"backend/src/Controller/VehicleImportExportController.php","where":"import serviceRecords / mot nested serviceRecords"}
      ]
    },
    {
      "name": "MotRecord",
      "classFile": "backend/src/Entity/MotRecord.php",
      "entityFields": ["id","vehicle","testDate","result","testCost","repairCost","mileage","testCenter","expiryDate","motTestNumber","testerName","isRetest","advisories","failures","repairDetails","notes","receiptAttachmentId","createdAt"],
      "exportedFields": ["testDate","expiryDate","result","testCost","repairCost","mileage","testCenter","advisories","failures","repairDetails","notes","parts","consumables","serviceRecords"],
      "missingOnExport": ["id","motTestNumber","testerName","isRetest","receiptAttachmentId","createdAt"],
      "importHandling": "Import creates MotRecord and tries to associate nested parts/consumables/serviceRecords to the created MotRecord, preferring to attach to existing matching items when possible.",
      "issues": [
        "Export omits `motTestNumber` and `testerName` — useful DVSA identifiers.",
        "`repairCost` is exported but import preserves the provided value; to be canonical, server-side should recalc repairCost from attachments after import.",
        "Import attaches nested items but does not recalc/persist `repairCost` after attachment (recommend using `RepairCostCalculator`)."
      ],
      "recommendedFixes": [
        {"desc":"Include `motTestNumber`, `testerName`, `receiptAttachmentId` in export/import.","file":"backend/src/Controller/VehicleImportExportController.php","where":"export motRecords block and import motRecords block"},
        {"desc":"After importing/attaching all parts/consumables/serviceRecords to a MotRecord, call `RepairCostCalculator::recalculateAndPersist($motRecord)` to ensure `repairCost` is canonical.","file":"backend/src/Controller/VehicleImportExportController.php","where":"after persisting motRecord and related attachments"}
      ]
    },
    {
      "name": "FuelRecord",
      "classFile": "backend/src/Entity/FuelRecord.php",
      "entityFields": ["id","vehicle","date","litres","cost","mileage","fuelType","station","notes"],
      "exportedFields": ["date","litres","cost","mileage","fuelType","station","notes"],
      "missingOnExport": ["id"],
      "importHandling": "Imported straightforwardly; no major issues identified.",
      "issues": [],
      "recommendedFixes": []
    },
    {
      "name": "ServiceItem",
      "classFile": "backend/src/Entity/ServiceItem.php",
      "entityFields": ["id","serviceRecord","type","description","cost","quantity"],
      "exportedFields": ["items -> type, description, cost, quantity"],
      "missingOnExport": ["id"],
      "importHandling": "Items are exported as arrays inside serviceRecords and re-created on import.",
      "issues": ["No stable ids for ServiceItem — import always creates new items; fine in most cases but loses identity if items referenced elsewhere."],
      "recommendedFixes": []
    }
  ],
  "global_issues": [
    "Export omits many entity ids which prevents exact round-trip imports - consider optional `preserveIds` flag and strict ownership checks.",
    "Timestamps (`updatedAt`, `uploadedAt`) are inconsistently exported/preserved; adopt a consistent timezone ISO format on export and accept/validate on import.",
    "Attachment references (`receiptAttachmentId`) are exported as integer IDs; import sets the id but does not migrate attachments themselves — recommend exporting attachment metadata or a separate attachment export/import path.",
    "When associating nested items to MotRecords the import does not always trigger server-side recalculation of `repairCost` — call `RepairCostCalculator` after attaching items."
  ],
  "action_plan": [
    {"id":1,"task":"Add images export/import to VehicleImportExportController and persist VehicleImage entities","priority":"high","files":["backend/src/Controller/VehicleImportExportController.php","backend/src/Entity/VehicleImage.php"]},
    {"id":2,"task":"Include optional `id` on exported items behind a `preserveIds` flag and implement id-based matching in import","priority":"medium","files":["backend/src/Controller/VehicleImportExportController.php"]},
    {"id":3,"task":"Call existing `RepairCostCalculator` after importing/attaching MOT-related parts/consumables/serviceRecords","priority":"high","files":["backend/src/Controller/VehicleImportExportController.php","backend/src/Service/RepairCostCalculator.php"]},
    {"id":4,"task":"Export/import `updatedAt`/`uploadedAt` timestamps in ISO8601 and restore them on import when provided","priority":"low","files":["backend/src/Controller/VehicleImportExportController.php"]}
  ]
}
